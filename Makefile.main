# ScrappingBot - Makefile principal
# Commandes simplifiÃ©es pour le dÃ©veloppement et les tests

.PHONY: help test test-etl test-all clean install dev prod

# Variables
PYTHON := python
PIP := pip
VENV := .venv
PYTEST := python -m pytest

# Colors
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
BLUE := \033[0;34m
NC := \033[0m

.DEFAULT_GOAL := help

help: ## Afficher cette aide
	@echo "$(GREEN)ScrappingBot - Commandes disponibles$(NC)"
	@echo "===================================="
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

install: ## Installer les dÃ©pendances Python
	@echo "$(BLUE)Installation des dÃ©pendances...$(NC)"
	$(PIP) install -r requirements.txt
	@echo "$(GREEN)âœ… DÃ©pendances installÃ©es$(NC)"

test: ## Lancer tous les tests
	@echo "$(BLUE)ğŸ§ª ExÃ©cution de tous les tests...$(NC)"
	$(PYTEST) tests/ -v
	@echo "$(GREEN)âœ… Tests terminÃ©s$(NC)"

test-etl: ## Lancer les tests ETL uniquement
	@echo "$(BLUE)ğŸ”§ Tests ETL...$(NC)"
	$(PYTEST) tests/test_etl_normalize.py tests/test_etl_dedupe.py tests/test_schema.py -v
	@echo "$(GREEN)âœ… Tests ETL terminÃ©s$(NC)"

test-coverage: ## Tests avec couverture
	@echo "$(BLUE)ğŸ§ª Tests avec couverture...$(NC)"
	$(PYTEST) tests/ --cov=etl --cov-report=html --cov-report=term
	@echo "$(GREEN)âœ… Rapport de couverture gÃ©nÃ©rÃ©$(NC)"

test-unit: ## Tests unitaires seulement
	@echo "$(BLUE)ğŸ§ª Tests unitaires...$(NC)"
	$(PYTEST) tests/ -m "not integration" -v
	@echo "$(GREEN)âœ… Tests unitaires terminÃ©s$(NC)"

clean: ## Nettoyer les fichiers temporaires
	@echo "$(BLUE)ğŸ§¹ Nettoyage...$(NC)"
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .pytest_cache/
	rm -rf htmlcov/
	@echo "$(GREEN)âœ… Nettoyage terminÃ©$(NC)"

lint: ## VÃ©rifier la qualitÃ© du code
	@echo "$(BLUE)ğŸ” VÃ©rification du code...$(NC)"
	$(PYTHON) -m flake8 etl/ tests/ --max-line-length=100
	$(PYTHON) -m black --check etl/ tests/
	@echo "$(GREEN)âœ… Code vÃ©rifiÃ©$(NC)"

format: ## Formater le code
	@echo "$(BLUE)ğŸ¨ Formatage du code...$(NC)"
	$(PYTHON) -m black etl/ tests/
	$(PYTHON) -m isort etl/ tests/
	@echo "$(GREEN)âœ… Code formatÃ©$(NC)"

# Docker commands
docker-build: ## Construire les images Docker
	@echo "$(BLUE)ğŸ³ Construction des images Docker...$(NC)"
	make -f Makefile.docker build
	@echo "$(GREEN)âœ… Images construites$(NC)"

docker-up: ## DÃ©marrer les services Docker
	@echo "$(BLUE)ğŸ³ DÃ©marrage des services Docker...$(NC)"
	make -f Makefile.docker up
	@echo "$(GREEN)âœ… Services dÃ©marrÃ©s$(NC)"

docker-down: ## ArrÃªter les services Docker
	@echo "$(BLUE)ğŸ³ ArrÃªt des services Docker...$(NC)"
	make -f Makefile.docker down
	@echo "$(GREEN)âœ… Services arrÃªtÃ©s$(NC)"

docker-test: ## Tests dans l'environnement Docker
	@echo "$(BLUE)ğŸ³ Tests Docker...$(NC)"
	make -f Makefile.docker test-docker
	@echo "$(GREEN)âœ… Tests Docker terminÃ©s$(NC)"

# Scripts management
deploy: ## DÃ©ployer l'application
	@echo "$(BLUE)ğŸš€ DÃ©ploiement...$(NC)"
	./scripts/deploy.sh
	@echo "$(GREEN)âœ… DÃ©ploiement terminÃ©$(NC)"

start: ## DÃ©marrer l'application
	@echo "$(BLUE)â–¶ï¸ DÃ©marrage...$(NC)"
	./scripts/start.sh
	@echo "$(GREEN)âœ… Application dÃ©marrÃ©e$(NC)"

stop: ## ArrÃªter l'application
	@echo "$(BLUE)â¹ï¸ ArrÃªt...$(NC)"
	./scripts/stop.sh
	@echo "$(GREEN)âœ… Application arrÃªtÃ©e$(NC)"

health: ## VÃ©rifier la santÃ© des services
	@echo "$(BLUE)ğŸ¥ VÃ©rification de santÃ©...$(NC)"
	./scripts/health-check.sh

monitor: ## Monitoring en temps rÃ©el
	@echo "$(BLUE)ğŸ“Š Monitoring...$(NC)"
	./scripts/monitor.sh

dev: ## Mode dÃ©veloppement
	@echo "$(BLUE)ğŸ› ï¸ Mode dÃ©veloppement...$(NC)"
	make -f Makefile.docker dev

prod: ## Mode production
	@echo "$(BLUE)ğŸ­ Mode production...$(NC)"
	make -f Makefile.docker prod
